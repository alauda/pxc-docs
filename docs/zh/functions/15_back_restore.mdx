---
sourceSHA: cd1bd5486a483a737928b18657b41488ec10f148d5f48a5dd0cfda8ac34366db
weight: 15
---

# 备份与恢复

数据库备份与恢复是确保数据安全和业务连续性的关键功能。通过定期备份数据库，可以在数据丢失、损坏或操作错误时快速恢复数据，从而最大程度地减少业务中断和数据损失。

## 前提条件

在进行备份之前，请声明存储位置。您可以选择以下两种方法之一。

- 持久卷声明（PVC，Kubernetes PersistentVolumeClaim）：持久卷声明封装了对存储资源的请求配置，并根据请求的访问模式、存储大小和其他信息，自动匹配集群中合适的持久卷。

- 外部 S3 存储：S3（Amazon Simple Storage Service）是亚马逊提供的一种对象存储服务。如果您需要将数据备份到您自己的 S3 存储桶，请与管理员确认该 S3 存储已集成到您的项目中。

## 操作步骤

<Tabs>
  <Tab label="CLI">
    1. 配置存储位置
    
    - 使用 PVC 进行存储

    ```bash
    kubectl patch mysql -n <namespace> <name> --type='merge' --patch '
    spec:
      pxc:
        backup:
          storages:
            <storageName>:
              type: filesystem
              volume:
                persistentVolumeClaim:
                  accessModes:
                    - ReadWriteOnce
                  resources:
                    requests:
                      storage: <size>Gi
                  storageClassName: <storageClass>
    ```

    - 使用 S3 进行存储
    
      创建 S3 密钥

    ```bash
    kubectl -n <namespace> create secret generic <backupSecretName> --from-literal=AWS_ACCESS_KEY_ID=$(accessKeyId) --from-literal=AWS_SECRET_ACCESS_KEY=$(secretAccessKey)
    ```

    配置 S3 存储

    ```bash
    kubectl patch mysql -n $namespace $name --type='merge' --patch '
    spec:
      pxc:
        backup:
          storages:
            <storageName>:
              type: s3
              s3:
                bucket: <bucket>
                credentialsSecret: <backupSecretName>
                endpointUrl: <endpointUrl>
    ```

    2. 自动备份
       在 CR 的 spec.pxc.backup 中添加自动备份配置，其中 schedule 字段定义备份周期。`<storageName>` 字段指的是在第 1 步创建的备份存储名称。

    ```bash
    kubectl patch mysql -n $namespace $name --type='merge' --patch '
    spec:
      pxc:
        backup:
          schedule:
          - keep: 5
            name: daily-backup
            schedule: 0 0 * * *
            storageName: <storageName>
    '
    ```

    3. 手动备份

    ```bash
    kubectl -n <namespace> apply -f - <<EOF
    apiVersion: pxc.percona.com/v1
    kind: PerconaXtraDBClusterBackup
    metadata:
      labels:
        cluster: <name>
        trigger.type: manual
      name: <backupName>
      namespace: <namespace>
    spec:
      pxcCluster: <name>
      storageName: <storageName>
    EOF
    ```

    4. 查看备份状态

    ```bash
    kubectl get PerconaXtraDBClusterBackup -n <namespace> <backupName> 
    ```

    5. 使用备份进行恢复

    ```bash
    apiVersion: pxc.percona.com/v1
    kind: PerconaXtraDBClusterRestore
    metadata:
      labels:
        cluster: <name>
      name: <restoreName>
      namespace: <namespace>
    spec:
      backupName: <backupName>
      pxcCluster: <name>
    EOF
    ```
  </Tab>

  <Tab label="Web Console">
    #### 立即备份（全量）

    立即备份正在运行的 MySQL-PXC 实例。

    ##### 前提条件

    确保实例处于 **运行中** 状态。

    ##### 操作步骤

    1. 在左侧导航栏中，单击 **MySQL-PXC**。

    2. 单击 ***命名空间名称***。

    3. 单击 ***实例名称***。

    4. 在 **备份与恢复** 标签页中，单击 **创建数据备份**。

    5. 设置参数并单击 **创建**。备份的时长取决于数据量和网络条件；请耐心等待。

    #### 自动备份（全量）

    指定备份时间；到达指定时间后，平台将自动备份 MySQL-PXC 实例并定期执行备份。

    ##### 操作步骤

    1. 在左侧导航栏中，单击 **MySQL-PXC**。

    2. 单击 ***命名空间名称***。

    3. 单击 ***实例名称***。

    4. 在 **备份与恢复** 标签页中，点击编辑。

    5. 启用 **自动备份** 并设置参数。

       **说明**：**存储位置** 为当前项目可用的 S3 存储。

    6. 单击 **更新**。

    **说明**：

    - 自动备份名称中的时间戳为 UTC 时间（与控制器管理器相同）；在本例中，表示此备份于北京时间 2021 年 2 月 2 日 18:00 开始执行。

    - 如果是自动备份的时间，但实例未处于 **运行中** 状态，平台将等待实例准备就绪后再开始备份。

    #### 恢复实例

    将备份数据恢复到目标实例。

    ##### 前提条件

    确保目标实例处于 **运行中** 状态。

    ##### 操作步骤

    1. 在左侧导航栏中，单击 **MySQL-PXC**。

    2. 单击 ***命名空间名称***。

    3. 单击 ***实例名称***。

    4. 在 **备份与恢复** 标签页中，单击 **恢复**。

    5. 选择目标实例并单击 **恢复**。请耐心等待，直到目标实例显示 **恢复成功** 状态。

    #### 删除备份

    支持删除备份数据。

    ##### 操作步骤

    1. 在左侧导航栏中，单击 **MySQL-PXC**。

    2. 单击 ***命名空间名称***。

    3. 单击 ***实例名称***。

    4. 在 **备份与恢复** 标签页中，单击 **删除** 并确认。

       当 S3 备份数据被删除时，存储中的数据也将被删除。
  </Tab>
</Tabs>
