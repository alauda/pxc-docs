# 备份恢复

## 功能介绍
数据库备份与恢复是确保数据安全和业务连续性的关键功能。通过定期备份数据库，可以在数据丢失、损坏或误操作时快速恢复数据，最大限度地减少业务中断和数据损失。


## 前提条件：

进行备份前，请根据数据量声明存储。以下两类方式任选其一即可。

* 持久卷声明（PVC，Kubernetes PersistentVolumeClaim）：持久卷声明封装了存储资源请求配置，会根据请求的访问模式、存储大小等信息，自动匹配集群中合适的持久卷。您可在 Container Platform 中配置持久卷声明。

* 外接 S3 存储：S3（Amazon Simple Storage Service）是亚马逊提供的一种对象存储服务。如果您需要将数据备份至自有的 S3 存储桶中，请与管理员确认已将 S3 存储接入您的项目。


## 操作步骤
<Tabs>
<Tab label="命令行操作">
1. 配置存储位置
- 使用 pvc 进行存储
```bash
kubectl patch mysql -n $namespace $name --type='merge' --patch '
spec:
  pxc:
    backup:
      storages:
        $(storageName):
          type: filesystem
          volume:
            persistentVolumeClaim:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: ${size}Gi
              storageClassName: ${storageClass}
```

- 使用 s3 进行存储
创建 s3 secret
```bash
kubectl -n $namespace create secret generic $(backupSecretName) --from-literal=AWS_ACCESS_KEY_ID=$(accessKeyId) --from-literal=AWS_SECRET_ACCESS_KEY=$(secretAccessKey)
```
配置 s3 存储
```bash
kubectl patch mysql -n $namespace $name --type='merge' --patch '
spec:
  pxc:
    backup:
      storages:
        $(storageName):
          type: s3
          s3:
            bucket: $(bucket)
            credentialsSecret: $(backupSecretName)
            endpointUrl: $(endpointUrl)
```
2. 自动备份
在 CR 的 spec.pxc.backup 中添加自动备份配置，其中 schedule 字段为备份周期。storageName 字段为步骤1创建的备份存储名称。
```bash
kubectl patch mysql -n $namespace $name --type='merge' --patch '
spec:
  pxc:
    backup:
      schedule:
      - keep: 5
        name: daily-backup
        schedule: 0 0 * * *
        storageName: $(storageName)
'
```

3. 手动备份
```bash
kubectl -n $namespace apply -f - <<EOF
apiVersion: pxc.percona.com/v1
kind: PerconaXtraDBClusterBackup
metadata:
  labels:
    cluster: $name
    trigger.type: manual
  name: $backupName
  namespace: $namespace
spec:
  pxcCluster: $name
  storageName: $storageName
EOF
```

4. 查看备份状态
```bash
kubectl get PerconaXtraDBClusterBackup -n $namespace $backupName 
```

5. 使用备份进行恢复
```bash
apiVersion: pxc.percona.com/v1
kind: PerconaXtraDBClusterRestore
metadata:
  labels:
    cluster: $name
  name: $restoreName
  namespace: $namespace
spec:
  backupName: $backupName
  pxcCluster: $name
EOF
```
</Tab>


<Tab label="界面操作"> 
#### 立即备份（全量）

立即备份正在运行中的 MySQL-PXC 实例。

##### 前提条件

确保实例为 **运行中** 状态。

##### 操作步骤

1. 在左侧导航栏中，单击 **MySQL-PXC**。

2. 单击 ***命名空间的名称***。

2. 单击 ***实例名称*** 。
    
3. 在 **备份恢复** 页签中，单击 **创建数据备份**。

4. 设置参数，并单击 **创建**。备份耗时与数据量及网络状况有关，请耐心等待。



#### 自动备份（全量）

指定备份时间，到期后平台将自动备份 MySQL-PXC 实例，且将周期性执行备份。

##### 操作步骤

1. 在左侧导航栏中，单击 **MySQL-PXC**。

2. 单击 ***命名空间的名称***。

2. 单击 ***实例名称*** 。
    
3. 在 **备份恢复** 页签中，点击编辑。

4. 开启 **自动备份**，并设置参数。

    **说明**：**存储位置** 为可供当前项目使用的 S3 存储。

5. 单击 **更新**。

**说明**：
  
* 自动备份名称中的时间戳为 UTC 时间（同 Controller Manager），本例中表示此备份于北京时间 2021 年 02 月 02 日 18:00 开始执行。
    
* 如果已到自动备份时间，可实例未处于 **运行中** 状态，平台将等待实例就绪后开始备份。

#### 恢复实例

将备份数据恢复至目标实例。

##### 前提条件

确保目标实例为 **运行中** 状态。

##### 操作步骤

1. 在左侧导航栏中，单击 **MySQL-PXC**。

2. 单击 ***命名空间的名称***。

2. 单击 ***实例名称*** 。
    
3. 在 **备份恢复** 页签中，单击 **恢复**。

4. 选择目标实例，单击 **恢复**。请耐心等待，直至目标实例为 **恢复成功** 状态。


#### 删除备份

支持删除备份数据。

##### 操作步骤

1. 在左侧导航栏中，单击 **MySQL-PXC**。

2. 单击 ***命名空间的名称***。

2. 单击 ***实例名称*** 。

3. 在 **备份恢复** 页签中，单击 **删除**，并确认。

    S3 备份数据删除后，S3 存储中的数据也会删除。

</Tab>

</Tabs>