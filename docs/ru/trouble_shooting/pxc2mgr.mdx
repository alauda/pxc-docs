---
weight: 10
sourceSHA: 16be5091ed4058686b7e19bcea0242dba9b8d601a59fef11ddd43eb4a347a903
---

# Миграция данных MySQL-PXC в MySQL-MGR

## Предварительные требования

- Узлы MySQL-PXC должны быть отключены.

- Кластер должен иметь достаточное количество процессоров, памяти, хранилища и других ресурсов для создания кластера MySQL-MGR с такими же характеристиками, как у MySQL-PXC.

## Заметки

- Сторона приложения должна обновить драйвер MySQL до версии MySQL-MGR; вы можете обратиться к [Соединителям и API](https://dev.mysql.com/doc/refman/8.0/en/connectors-apis.html).

- Используйте кодировку символов `utf8mb4`.

  - Сторона приложения должна использовать `utf8mb4`.

  - На стороне базы данных необходимо выполнить конвертацию библиотеки и таблиц в `utf8mb4`.

  SQL для конвертации символов выглядит следующим образом.

  ```
  # Преобразовать кодировку базы данных в utf8mb4
  ALTER DATABASE db_name DEFAULT CHARACTER SET = utf8mb4;

  # Преобразовать кодировку таблицы в utf8mb4
  ALTER TABLE db_name.table_name CONVERT TO CHARACTER SET utf8mb4;
  ```

  **Совет**: Чем больше объем данных в таблице, тем дольше будет время преобразования.

- MySQL-MGR требует наличия первичного ключа в таблицах.

  - Даже если в таблице нет первичного ключа, во время импорта в MySQL-MGR будет автоматически создан "невидимый" первичный ключ; рекомендуется, чтобы бизнес-стороны использовали явные первичные ключи.

    **Совет**: Он будет отображаться в `SHOW TABLE`, но `SELECT` будет скрывать это поле.

  - Чтобы найти таблицы в бизнес-базе данных, которые не имеют первичного ключа:

  ```
  SELECT 
      CONCAT(t1.TABLE_SCHEMA, '.', t1.TABLE_NAME)
  FROM
      information_schema.tables t1
          LEFT JOIN
      (SELECT DISTINCT
          t.TABLE_SCHEMA, t.TABLE_NAME, t.COLUMN_KEY
      FROM
          information_schema.`COLUMNS` t
      WHERE
          t.COLUMN_KEY = 'PRI') t2 ON t1.TABLE_SCHEMA = t2.TABLE_SCHEMA
          AND t1.TABLE_NAME = t2.TABLE_NAME
  WHERE
      t1.TABLE_SCHEMA NOT IN ('information_schema' , 'mysql', 'performance_schema', 'sys')
          AND t2.COLUMN_KEY IS NULL;
  ```

  - Добавьте автоинкрементный первичный ключ:

  ```
  ALTER TABLE table_name ADD COLUMN id BITINT NOT NULL AUTO_INCREMENT PRIMARY KEY;
  ```

## Рабочий процесс

**Примечание**: При использовании кода из этого документа, пожалуйста, замените его на реальные параметры экземпляра.

### Проверьте состояние кластера MySQL-PXC

Состояние кластера MySQL-PXC должно быть нормальным перед резервным копированием данных.

1. В левой панели навигации нажмите **MySQL-PXC**.

2. Нажмите ***Имя пространства имён***.

3. Нажмите ***Имя экземпляра***.

4. На вкладке **Подробности** состояния **Основная информация**, **Конфигурация ресурсов** и **ProxySQL** должны быть **Запускается**.

5. На вкладке **Топология** состояние каждого узла ProxySQL и MySQL должно быть **Нормальное**.

### Найдите узлы MySQL-PXC для чтения/записи

1. Найдите IP-адрес ProxySQL.

```
[root@g1-rm1 ~]# kubectl get pod -n demo-ds1 -owide | grep 'proxysql'
demo-proxysql-0                 3/3     Running   0               4h57m   10.4.0.28     192.168.176.247   <none>           <none>
demo-proxysql-1                 3/3     Running   0               4h57m   10.4.0.49     192.168.177.35    <none>           <none>
demo-proxysql-2                 3/3     Running   0               4h57m   10.4.0.54     192.168.176.25    <none>           <none>
```

2. Подключитесь к любому Pod ProxySQL, чтобы найти узлы для чтения/записи.

```
# kubectl exec -it demo-proxysql-0 -c proxysql -n demo-ds1 -- mysql -uproxyadmin -h10.4.0.28 -p'jtr8eO0kS?lq' -P6032 -e "SELECT * FROM runtime_mysql_servers WHERE hostgroup_id=11"
mysql: [Warning] Использование пароля в командной строке может быть небезопасным.
+--------------+------------------------------------------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+
| hostgroup_id | hostname                                       | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |
+--------------+------------------------------------------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+
| 11           | demo-pxc-0.demo-pxc.demo-ds1.svc.cluster.local | 3306 | 0         | ONLINE | 1001   | 0           | 600             | 0                   | 0       | 0              |         |
+--------------+------------------------------------------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+
```

По выводу определите имя MySQL-PXC, к которому принадлежит узел для чтения/записи `demo-pxc-0.demo-pxc.demo-ds1.svc.cluster.local`.

```
[root@g1-rm1 ~]# kubectl exec -it demo-pxc-0 -n demo-ds1 -- mysql -uroot -hlocalhost -p'jtr8eO0kS?lq' -e "SHOW GLOBAL STATUS LIKE 'wsrep_cluster_state_uuid'"
mysql: [Warning] Использование пароля в командной строке может быть небезопасным.
+--------------------------+--------------------------------------+
| Variable_name            | Value                                |
+--------------------------+--------------------------------------+
| wsrep_cluster_state_uuid | 60fd1cc7-1628-11ee-90b2-c6e61fc5eaef |
+--------------------------+--------------------------------------+

[root@g1-rm1 ~]# kubectl exec -it demo-pxc-1 -n demo-ds1 -- mysql -uroot -hlocalhost -p'jtr8eO0kS?lq' -e "SHOW GLOBAL STATUS LIKE 'wsrep_cluster_state_uuid'"
mysql: [Warning] Использование пароля в командной строке может быть небезопасным.
+--------------------------+--------------------------------------+
| Variable_name            | Value                                |
+--------------------------+--------------------------------------+
| wsrep_cluster_state_uuid | 60fd1cc7-1628-11ee-90b2-c6e61fc5eaef |
+--------------------------+--------------------------------------+

[root@g1-rm1 ~]# kubectl exec -it demo-pxc-2 -n demo-ds1 -- mysql -uroot -hlocalhost -p'jtr8eO0kS?lq' -e "SHOW GLOBAL STATUS LIKE 'wsrep_cluster_state_uuid'"
mysql: [Warning] Использование пароля в командной строке может быть небезопасным.
+--------------------------+--------------------------------------+
| Variable_name            | Value                                |
+--------------------------+--------------------------------------+
| wsrep_cluster_state_uuid | 60fd1cc7-1628-11ee-90b2-c6e61fc5eaef |
+--------------------------+--------------------------------------+
```

### Остановите MySQL-PXC от предоставления внешних услуг

**Примечание**: Не выполняйте операции записи на стороне приложения, так как это приведет к неполной резервной копии.

1. В левой панели навигации нажмите **MySQL-PXC**.

2. Нажмите ***Имя пространства имён***.

3. Нажмите ***Имя экземпляра***.

4. Нажмите **Действия** > **Обновить**.

5. Нажмите **YAML**.

6. Измените значение параметра `pxc.proxysql.size` на `0`.

7. Нажмите **Обновить**.

### Создайте экземпляр MySQL-MGR

**Примечание**: Характеристики ресурсов для созданного экземпляра MySQL-MGR не должны быть ниже характеристик экземпляра MySQL-PXC.

### Проверьте состояние кластера MySQL-MGR

1. В левой панели навигации нажмите **MySQL-MGR**.

2. Нажмите ***Имя пространства имён***.

3. Нажмите ***Имя экземпляра***.

4. На вкладке **Подробности** состояния **Основная информация**, **Конфигурация ресурсов** и **MySQL Router** должны быть **Запускается**.

5. На вкладке **YAML** значения `status.conditions.type` и `status.state` должны быть `ready`.

### Найдите узлы MySQL-MGR для чтения/записи

Узлы с `MEMBER_ROLE` как `PRIMARY` являются узлами для чтения/записи MySQL-MGR.

```
[root@g1-rm1 ~]# kubectl exec -it demo-0 -c mysql -n demo-ds1 -- mysql -uroot -hlocalhost -p'GLK1nqWF17JqrvpJ' -e "SELECT * FROM performance_schema.replication_group_members"
mysql: [Warning] Использование пароля в командной строке может быть небезопасным.
+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+----------------------------+
| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE | MEMBER_ROLE | MEMBER_VERSION | MEMBER_COMMUNICATION_STACK |
+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+----------------------------+
| group_replication_applier | 5bc1839e-162a-11ee-a212-00000071f44e | demo-0.demo |        3306 | ONLINE       | PRIMARY     | 8.0.30         | MySQL                      |
| group_replication_applier | 6f9f1f36-162a-11ee-a21a-000000ade638 | demo-1.demo |        3306 | ONLINE       | SECONDARY   | 8.0.30         | MySQL                      |
| group_replication_applier | 96300b66-162a-11ee-a33f-00000093bb13 | demo-2.demo |        3306 | ONLINE       | SECONDARY   | 8.0.30         | MySQL                      |
+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+----------------------------+
```

### Определите, какие базы данных необходимо сделать резервными из MySQL-PXC

- Исключите системные базы данных MySQL: `information_schema`, `mysql`, `performance_schema` и `sys`.

- Для бизнес-баз данных: Зафиксируйте бизнес-базы данных для резервного копирования и при использовании инструмента резервного копирования `mysqldump` указывайте базы данных с помощью опции `-B`.

Например, из следующего списка баз данных необходимо сделать резервные копии бизнес-баз данных `test1`, `test2` и `test3`.

```
[root@g1-rm1 ~]# kubectl exec -it demo-pxc-0 -n demo-ds1 -c pxc -- mysql -uroot -p'jtr8eO0kS?lq' -h10.4.0.35 -e "SHOW DATABASES"
mysql: [Warning] Использование пароля в командной строке может быть небезопасным.
+--------------------+
| База данных       |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
| test1              |
| test2              |
| test3              |
+--------------------+
```

### Развертывание контейнера MySQL-MGR для резервного копирования и восстановления

#### **Создание PVC**

1. В представлении **Платформа контейнеров** в левой панели навигации нажмите **Хранилище** > **Запросы на постоянный объем**.

2. Нажмите **Создать запрос на постоянный объем**.

3. Заполните параметры конфигурации PVC.

   **Примечание**: Используйте TopoLVM в качестве класса хранилища.

4. Нажмите **Создать**; статус PVC должен быть **Ожидание привязки**.

#### **Создание PV**

Пожалуйста, свяжитесь с **Администратором платформы** для создания PV на основе следующего YAML. После создания PV проверьте, что статус PVC стал **Привязан**.

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: mgr-backcup-pv # имя pv
  annotations: {}
  labels: {}
spec:
  capacity:
    storage: 5Gi # укажите объем хранения
  csi:
    driver: topolvm.cybozu.com
    volumeHandle: baef103d-d2de-4ca9-bb4b-1dad722975b9
    fsType: xfs
  accessModes:
    - ReadWriteOnce
  claimRef:
    kind: PersistentVolumeClaim
    namespace: demo-ds1	# укажите пространство имён
    name: mgr-backcup-pvc # укажите имя для привязки PVC
  persistentVolumeReclaimPolicy: Delete
  storageClassName: sc-topolvm # укажите класс хранилища
  volumeMode: Filesystem
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: topology.topolvm.cybozu.com/node
              operator: In
              values:
                - 192.168.177.35 # укажите IP-адрес хост-процессора, где создан PV
```

#### **Развертите контейнер MySQL-MGR**

1. Проверьте адрес образа MySQL-MGR.

   ```
   [root@g1-rm1 ~]# kubectl get pod demo-0 -n demo-ds1 -o yaml | grep 'image:' | grep 'mysql-server'
       image: idc1.xmysql.com/3rdparty/mysql/mysql-server:8.0.30-cfd84cde
       image: idc1.xmysql.com/3rdparty/mysql/mysql-server:8.0.30-cfd84cde
   ```

2. В представлении **Платформа контейнеров** в левой панели навигации нажмите **Компоненты вычислений** > **Развертывания**.

3. Нажмите **Создать развертывание**.

4. Выберите метод **Ввод**, заполните ***Адрес образа*** и нажмите **ОК**.

5. В **Поды** > **Тома** нажмите **Добавить**.

6. Заполните конфигурацию тома, используя PVC, созданный в этом документе, в качестве тома для хранения для контейнера MySQL.

7. Нажмите **Добавить**.

8. Заполните конфигурацию контейнера.

9. Нажмите **Создать**.

### Резервное копирование бизнес-баз данных MySQL-PXC

1. Получите IP-адрес Pod MySQL-PXC для чтения/записи.

   ```
   [root@g1-rm1 ~]# kubectl get pod -o wide -n demo-ds1 | grep 'pxc'
   demo-pxc-0                      3/3     Running   0              4d4h    10.4.0.35     192.168.176.227   <none>           <none>
   demo-pxc-1                      3/3     Running   0              4d4h    10.4.0.70     192.168.176.247   <none>           <none>
   demo-pxc-2                      3/3     Running   0              4d4h    10.4.0.162    192.168.176.25    <none>           <none>
   ```

2. Получите корневой пароль для MySQL-PXC.

   ```
   [root@g1-rm1 ~]# kubectl exec -it demo-pxc-0 -n demo-ds1 -c pxc -- /bin/bash
   bash-5.1$ env | grep 'MYSQL_ROOT_PASSWORD' 
   MYSQL_ROOT_PASSWORD=jtr8eO0kS?lq
   ```

3. Войдите в контейнер резервного копирования и восстановления MySQL, созданный в этом документе, например, имя Pod `mgr-backcup-9f87d46c4-kwkps`.

   ```
   [root@g1-rm1 ~]# kubectl exec -it mgr-backcup-9f87d46c4-kwkps -n demo-ds1 -- /bin/bash
   ```

   **Совет**: Имя Pod можно просмотреть в списке контейнерных групп данного развертывания.

4. Выполните резервное копирование бизнес-базы данных.

   ```
   [root@mgr-backcup-9f87d46c4-kwkps /]# mysqldump --user=root --host=10.4.0.35 --password='jtr8eO0kS?lq' --column-statistics=0 --single-transaction --source-data=1 --set-gtid-purged=AUTO --triggers -R -E -B test1 test2 test3 > /var/lib/mysql/$(date +"%Y%m%d%H%M%S")_fullbackup.sql
   mysqldump: [Warning] Использование пароля в командной строке может быть небезопасным.
   ```

   Объяснение параметров:

   `--password`: Корневой пароль MySQL-PXC.

   `--host`: Укажите IP-адрес Pod для чтения/записи MySQL-PXC.

   `-B`: Укажите названия бизнес-баз данных для резервного копирования в MySQL-PXC, разделённые пробелами.

5. Проверьте размер логического резервного копирования.

   ```
   [root@mgr-backcup-9f87d46c4-kwkps /]# du -lh /var/lib/mysql/20230705102203_fullbackup.sql 
   677M	/var/lib/mysql/20230705102203_fullbackup.sql
   ```

### Восстановление бизнес-данных

```
[root@g1-rm1 ~]# kubectl get pod demo-0 -n demo-ds1 -o wide
NAME     READY   STATUS    RESTARTS   AGE   IP           NODE             NOMINATED NODE   READINESS GATES
demo-0   3/3     Running   0          20h   10.4.0.170   192.168.177.35   <none>           <none>

[root@g1-rm1 ~]# kubectl exec -it mgr-backcup-9f87d46c4-kwkps -n demo-ds1 -- /bin/bash

[root@mgr-backcup-9f87d46c4-kwkps /]# mysql -uroot -h10.4.0.170 -p'GLK1nqWF17JqrvpJ' < /var/lib/mysql/20230705102203_fullbackup.sql
mysql: [Warning] Использование пароля в командной строке может быть небезопасным.


[root@mgr-backcup-9f87d46c4-kwkps /]# mysql -uroot -h10.4.0.170 -p'GLK1nqWF17JqrvpJ'
mysql: [Warning] Использование пароля в командной строке может быть небезопасным.
Добро пожаловать в монитор MySQL.  Команды заканчиваются на ; или \g.
Ваш ID соединения MySQL: 367123
Версия сервера: 8.0.30 MySQL Community Server - GPL

Copyright (c) 2000, 2022, Oracle и/или её аффилированные лица.

Oracle является зарегистрированным товарным знаком корпорации Oracle и/или её аффилированных лиц. Другие названия могут быть товарными знаками их соответствующих владельцев.

Не удается прочитать базу данных termcap; используется настройка терминала с минимальными возможностями.
Введите 'help;' или '\h' для помощи. Чтобы очистить текущее вводимое выражение, используйте '\c'.

mysql> SHOW DATABASES;
+-------------------------------+
| База данных                   |
+-------------------------------+
| information_schema            |
| mysql                         |
| mysql_innodb_cluster_metadata |
| performance_schema            |
| sys                           |
| test1                         |
| test2                         |
| test3                         |
+-------------------------------+
8 строк в наборе (0.01 сек)

mysql> use test1;
Чтение информации о таблицах для завершения имен таблиц и столбцов
Вы можете отключить эту функцию для более быстрого запуска с -A

База данных изменена
mysql> SHOW TABLES;
+-----------------+
| Tables_in_test1 |
+-----------------+
| sbtest1         |
| sbtest2         |
| sbtest3         |
| sbtest4         |
| sbtest5         |
| sbtest6         |
+-----------------+
6 строк в наборе (0.01 сек)

mysql> SELECT COUNT(1) FROM test1.sbtest1;
+----------+
| COUNT(1) |
+----------+
|   200000 |
+----------+
1 строка в наборе (0.03 сек)

mysql> SHOW CREATE TABLE test2.sbtest1\G
*************************** 1. строка ***************************
       Таблица: sbtest1
Создать таблицу: CREATE TABLE `sbtest1` (
  `my_row_id` bigint unsigned NOT NULL AUTO_INCREMENT /*!80023 INVISIBLE */,
  `k` int NOT NULL DEFAULT '0',
  `c` char(120) NOT NULL DEFAULT '',
  `pad` char(60) NOT NULL DEFAULT '',
  PRIMARY KEY (`my_row_id`),
  KEY `k_1` (`k`)
) ENGINE=InnoDB AUTO_INCREMENT=200003 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
1 строка в наборе (0.00 сек)

mysql> SHOW CREATE TABLE test3.sbtest1\G
*************************** 1. строка ***************************
       Таблица: sbtest1
Создать таблицу: CREATE TABLE `sbtest1` (
  `id` int NOT NULL AUTO_INCREMENT,
  `k` int NOT NULL DEFAULT '0',
  `c` char(120) NOT NULL DEFAULT '',
  `pad` char(60) NOT NULL DEFAULT '',
  PRIMARY KEY (`id`),
  KEY `k_1` (`k`)
) ENGINE=InnoDB AUTO_INCREMENT=600001 DEFAULT CHARSET=utf8mb3
1 строка в наборе (0.00 сек)
```

### Резервное копирование учетных записей бизнеса MySQL-PXC

1. Войдите в Pod MySQL-MGR для резервного копирования таблицы пользователей MySQL-PXC.

   ```
   [root@g1-rm1 ~]# kubectl exec -it mgr-backcup-9f87d46c4-kwkps -n demo-ds1 -- /bin/bash

   [root@g1-rm1 ~]# mysqldump --user=root --host=10.4.0.35 --password='jtr8eO0kS?lq' --column-statistics=0 --single-transaction --source-data=1 --set-gtid-purged=AUTO --triggers -R -E mysql user > /var/lib/mysql/$(date +"%Y%m%d%H%M%S")_mysql.user.sql

   [root@g1-rm1 ~]# du -lh /var/lib/mysql/20230705132502_mysql.user.sql 
   8.0K	/var/lib/mysql/20230705132502_mysql.user.sql
   ```

2. Получите SQL-записи для учетных записей: `INSERT INTO`.

   ```
   [root@g1-rm1 ~]# cat /var/lib/mysql/20230705132502_mysql.user.sql | grep 'INSERT INTO'
   INSERT INTO `user` VALUES ('localhost','root','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,'mysql_native_password','*40C19F6316A46A0E68DCCBC18034271BE5DDD704','N','2023-06-29 02:55:28',NULL,'N'),('localhost','mysql.session','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','Y','N','N','N','N','N','N','N','N','N','N','N','N','N','','','','',0,0,0,0,'mysql_native_password','*THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE','N','2023-06-29 02:55:09',NULL,'Y'),('localhost','mysql.sys','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','','','','',0,0,0,0,'mysql_native_password','*THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE','N','2023-06-29 02:55:09',NULL,'Y'),('%','root','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,'mysql_native_password','*40C19F6316A46A0E68DCCBC18034271BE5DDD704','N','2023-06-29 02:55:28',NULL,'N'),('%','operator','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,'mysql_native_password','*40C19F6316A46A0E68DCCBC18034271BE5DDD704','N','2023-06-29 02:55:28',NULL,'N'),('%','xtrabackup','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','N','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,'mysql_native_password','*40C19F6316A46A0E68DCCBC18034271BE5DDD704','N','2023-06-29 02:55:28',NULL,'N'),('%','monitor','Y','N','N','N','N','N','Y','N','Y','N','N','N','N','N','N','Y','N','N','N','N','Y','N','N','N','N','N','N','N','N','','','','',0,0,0,100,'mysql_native_password','*40C19F6316A46A0E68DCCBC18034271BE5DDD704','N','2023-06-29 02:55:28',NULL,'N'),('localhost','clustercheck','N','N','N','N','N','N','N','N','Y','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','','','','',0,0,0,0,'mysql_native_password','*40C19F6316A46A0E68DCCBC18034271BE5DDD704','N','2023-06-29 02:55:28',NULL,'N'),('%','test_user_2','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','N','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,'mysql_native_password','*BFC6130681D565DDE4C938BCDCD36073776A8F99','N','2023-07-03 07:13:13',NULL,'N'),('%','test_user_3','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','N','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,'mysql_native_password','*BFC6130681D565DDE4C938BCDCD36073776A8F99','N','2023-07-03 07:13:13',NULL,'N'),('%','test_user_1','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','N','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,'mysql_native_password','*BFC6130681D565DDE4C938BCDCD36073776A8F99','N','2023-07-03 07:14:52',NULL,'N');
   ```

3. Удалите системных пользователей MySQL-PXC, оставив только учетные записи бизнес-приложений.

   - Удалите системные учетные записи: `('localhost','root')`, `('localhost','mysql.session')`, `('localhost','mysql.sys')`, `('%','root')`, `('%','operator')`, `('%','monitor')`, `('localhost','clustercheck')`.

   - Сохраните учетные записи бизнес-приложений: `test_user_1`, `test_user_2`, `test_user_3`.

   ```
   INSERT INTO `user` VALUES ('%','test_user_2','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','N','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,'mysql_native_password','*BFC6130681D565DDE4C938BCDCD36073776A8F99','N','2023-07-03 07:13:13',NULL,'N'),('%','test_user_3','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','N','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,'mysql_native_password','*BFC6130681D565DDE4C938BCDCD36073776A8F99','N','2023-07-03 07:13:13',NULL,'N'),('%','test_user_1','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','N','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,'mysql_native_password','*BFC6130681D565DDE4C938BCDCD36073776A8F99','N','2023-07-03 07:14:52',NULL,'N');
   ```

### Импорт учетных записей бизнес-приложений

1. Измените записи учетных записей для добавления.

   **Примечание**: Не импортируйте учетную запись root.

   MySQL-MGR добавил 6 полей в `mysql.user` по сравнению с MySQL-PXC, поэтому при вставке записей учетных записей необходимо добавить следующие 6 полей: `Create_role_priv: Y`, `Drop_role_priv: Y`, `Password_reuse_history: NULL`, `Password_reuse_time: NULL`, `Password_require_current: NULL`, `User_attributes: NULL`. Соответственно, добавьте следующие значения к каждой записи вставки: `, 'Y', 'Y', NULL, NULL, NULL, NULL`.

   ```
   INSERT INTO `user` VALUES ('%','test_user_2','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','N','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,'mysql_native_password','*BFC6130681D565DDE4C938BCDCD36073776A8F99','N','2023-07-03 07:13:13',NULL,'N', 'Y', 'Y', NULL, NULL, NULL, NULL),('%','test_user_3','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','N','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,'mysql_native_password','*BFC6130681D565DDE4C938BCDCD36073776A8F99','N','2023-07-03 07:13:13',NULL,'N', 'Y', 'Y', NULL, NULL, NULL, NULL),('%','test_user_1','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','N','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,'mysql_native_password','*BFC6130681D565DDE4C938BCDCD36073776A8F99','N','2023-07-03 07:14:52',NULL,'N', 'Y', 'Y', NULL, NULL, NULL, NULL);
   ```

2. Вставьте записи учетных записей в MySQL-MGR.

   ```
   [root@g1-rm1 ~]# kubectl exec -it mgr-backcup-9f87d46c4-kwkps -n demo-ds1 -- /bin/bash

   [root@g1-rm1 ~]# mysql -uroot -h10.4.0.170 -p'GLK1nqWF17JqrvpJ'

   mysql> use mysql
   Чтение информации о таблицах для завершения имен таблиц и столбцов
   Вы можете отключить эту функцию для более быстрого запуска с -A

   mysql> INSERT INTO `user` VALUES ('%','test_user_2','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','N','Y','Y','Y','Y','Y','Y','Y','Y','
   Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,'mysql_native_password','*BFC6130681D565DDE4C938BCDCD36073776A8F99','N
   ','2023-07-03 07:13:13',NULL,'N', 'Y', 'Y', NULL, NULL, NULL, NULL),('%','test_user_3','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','N
   ','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,'mysql_native_password','*BFC613068
   1D565DDE4C938BCDCD36073776A8F99','N','2023-07-03 07:13:13',NULL,'N', 'Y', 'Y', NULL, NULL, NULL, NULL),('%','test_user_1','Y','Y'
   ,'Y','Y','Y','Y','Y','Y','Y','Y','N','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,
   'mysql_native_password','*BFC6130681D565DDE4C938BCDCD36073776A8F99','N','2023-07-03 07:14:52',NULL,'N', 'Y', 'Y', NULL, NULL, NUL
   L, NULL);
   Query OK, 3 rows affected (0.01 sec)
   Records: 3  Duplicates: 0  Warnings: 0

   mysql> FLUSH PRIVILEGES;
   Query OK, 0 rows affected (0.01 sec)

   mysql> SELECT user,host,plugin FROM mysql.user WHERE user LIKE 'test%';
   +-------------+------+-----------------------+
   | user        | host | plugin                |
   +-------------+------+-----------------------+
   | test_user_1 | %    | mysql_native_password |
   | test_user_2 | %    | mysql_native_password |
   | test_user_3 | %    | mysql_native_password |
   +-------------+------+-----------------------+
   3 строки в наборе (0.00 сек)
   ```

3. Проверьте, правильны ли учетные записи.

   ```
   [root@g1-rm1 ~]# kubectl get pod -n demo-ds1 -o wide | grep demo
   demo-0                          3/3     Running   0               4d11h   10.4.0.170    192.168.177.35    <none>           <none>
   demo-1                          3/3     Running   1 (4d11h ago)   4d11h   10.4.0.176    192.168.176.247   <none>           <none>
   demo-2                          3/3     Running   1 (4d11h ago)   4d11h   10.4.0.198    192.168.176.227   <none>           <none>

   [root@mgr-backcup-9f87d46c4-kwkps /]# mysql -utest_user_1 -h10.4.0.170 -p'zEjQM96Ha1=v' -e "SELECT USER()";
   mysql: [Warning] Использование пароля в командной строке может быть небезопасным.
   +-------------------------+
   | USER()                  |
   +-------------------------+
   | test_user_1@10.4.210.58 |
   +-------------------------+
   [root@mgr-backcup-9f87d46c4-kwkps /]# mysql -utest_user_2 -h10.4.0.176 -p'zEjQM96Ha1=v' -e "SELECT USER()";
   mysql: [Warning] Использование пароля в командной строке может быть небезопасным.
   +-------------------------+
   | USER()                  |
   +-------------------------+
   | test_user_2@10.4.210.58 |
   +-------------------------+
   [root@mgr-backcup-9f87d46c4-kwkps /]# mysql -utest_user_3 -h10.4.0.198 -p'zEjQM96Ha1=v' -e "SELECT USER()";
   mysql: [Warning] Использование пароля в командной строке может быть небезопасным.
   +-------------------------+
   | USER()                  |
   +-------------------------+
   | test_user_3@10.4.210.58 |
   +-------------------------+
   ```

### Дополнительно: Использование метода резервного копирования mysqldump на вычислительном узле (хосте)

Если текущему кластеру не хватает ресурсов и кластер MySQL-MGR с аналогичными характеристиками не был развернут, вы можете использовать `mysqldump` на хост-машине для выполнения резервного копирования.

**Процедура**:

1. Убедитесь, что состояние кластера MySQL-PXC нормально.

2. Остановите операции записи бизнеса и установите реплики ProxySQL на 0.

3. Выполните резервное копирование MySQL-PXC.
