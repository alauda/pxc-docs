---
weight: 15
sourceSHA: cd1bd5486a483a737928b18657b41488ec10f148d5f48a5dd0cfda8ac34366db
---

# Резервное копирование и восстановление

Резервное копирование и восстановление базы данных являются важными функциями для обеспечения безопасности данных и непрерывности бизнеса. Регулярное резервное копирование базы данных позволяет быстро восстановить данные в случае потери, повреждения или операционных ошибок, тем самым минимизируя сбои в бизнесе и потери данных.

## Предварительные условия

Перед выполнением резервного копирования укажите место хранения. Вы можете выбрать один из следующих двух методов.

- Запрос на постоянный том (PVC, Kubernetes PersistentVolumeClaim): Запрос на постоянный том инкапсулирует конфигурацию запроса для ресурсов хранения и автоматически сопоставляет подходящие постоянные тома в кластере на основе запрашиваемого режима доступа, размера хранилища и другой информации.

- Внешнее S3 хранилище: S3 (Amazon Simple Storage Service) – это сервис объектного хранения, предоставляемый Amazon. Если вам необходимо выполнить резервное копирование данных в ваш собственный S3 бакет, пожалуйста, подтвердите у администратора, что S3 хранилище было интегрировано в ваш проект.

## Процедура

<Tabs>
  <Tab label="CLI">
    1. Настройка места хранения

    - Использование PVC для хранения

    ```bash
    kubectl patch mysql -n <namespace> <name> --type='merge' --patch '
    spec:
      pxc:
        backup:
          storages:
            <storageName>:
              type: filesystem
              volume:
                persistentVolumeClaim:
                  accessModes:
                    - ReadWriteOnce
                  resources:
                    requests:
                      storage: <size>Gi
                  storageClassName: <storageClass>
    ```

    - Использование S3 для хранения
      Создание секрета S3

    ```bash
    kubectl -n <namespace> create secret generic <backupSecretName> --from-literal=AWS_ACCESS_KEY_ID=$(accessKeyId) --from-literal=AWS_SECRET_ACCESS_KEY=$(secretAccessKey)
    ```

    Настройка S3 хранилища

    ```bash
    kubectl patch mysql -n $namespace $name --type='merge' --patch '
    spec:
      pxc:
        backup:
          storages:
            <storageName>:
              type: s3
              s3:
                bucket: <bucket>
                credentialsSecret: <backupSecretName>
                endpointUrl: <endpointUrl>
    ```

    2. Автоматическое резервное копирование
       Добавьте настройки автоматического резервного копирования в spec.pxc.backup CR, где поле schedule определяет цикл резервного копирования. Поле `<storageName>` относится к имени хранилища резервных копий, созданному на Шаге 1.

    ```bash
    kubectl patch mysql -n $namespace $name --type='merge' --patch '
    spec:
      pxc:
        backup:
          schedule:
          - keep: 5
            name: daily-backup
            schedule: 0 0 * * *
            storageName: <storageName>
    '
    ```

    3. Ручное резервное копирование

    ```bash
    kubectl -n <namespace> apply -f - <<EOF
    apiVersion: pxc.percona.com/v1
    kind: PerconaXtraDBClusterBackup
    metadata:
      labels:
        cluster: <name>
        trigger.type: manual
      name: <backupName>
      namespace: <namespace>
    spec:
      pxcCluster: <name>
      storageName: <storageName>
    EOF
    ```

    4. Проверка статуса резервного копирования

    ```bash
    kubectl get PerconaXtraDBClusterBackup -n <namespace> <backupName> 
    ```

    5. Восстановление из резервной копии

    ```bash
    apiVersion: pxc.percona.com/v1
    kind: PerconaXtraDBClusterRestore
    metadata:
      labels:
        cluster: <name>
      name: <restoreName>
      namespace: <namespace>
    spec:
      backupName: <backupName>
      pxcCluster: <name>
    EOF
    ```
  </Tab>

  <Tab label="Web Console">
    #### Немедленное резервное копирование (Полное)

    Немедленно создайте резервную копию запущенного экземпляра MySQL-PXC.

    ##### Предварительные условия

    Убедитесь, что экземпляр находится в статусе **Рабочий**.

    ##### Процедура

    1. Нажмите **MySQL-PXC** в левой навигационной панели.

    2. Нажмите на ***имя пространства имен***.

    3. Нажмите на ***имя экземпляра***.

    4. Нажмите **Создать резервную копию данных** на вкладке **Резервное копирование и восстановление**.

    5. Установите параметры и нажмите **Создать**. Длительность резервного копирования зависит от объема данных и условий сети; пожалуйста, наберитесь терпения.

    #### Автоматическое резервное копирование (Полное)

    Укажите время резервного копирования; после достижения установленного времени платформа автоматически создаст резервную копию экземпляра MySQL-PXC и выполнит периодические резервные копирования.

    ##### Процедура

    1. Нажмите **MySQL-PXC** в левой навигационной панели.

    2. Нажмите на ***имя пространства имен***.

    3. Нажмите на ***имя экземпляра***.

    4. Нажмите «Изменить» на вкладке **Резервное копирование и восстановление**.

    5. Включите **Автоматическое резервное копирование** и установите параметры.

       **Примечание**: **Место хранения** - это S3 хранилище, доступное для текущего проекта.

    6. Нажмите **Обновить**.

    **Объяснение**:

    - Временная метка в имени автоматического резервного копирования находится в формате UTC (так же, как и контроллер менеджера); в этом примере она указывает, что резервное копирование было инициировано в 18:00 по пекинскому времени 2 февраля 2021 года.

    - Если пришло время автоматического резервного копирования, но экземпляр не находится в статусе **Рабочий**, платформа будет ждать, пока экземпляр будет готов начать резервное копирование.

    #### Восстановление экземпляра

    Восстановить данные резервной копии на целевой экземпляр.

    ##### Предварительные условия

    Убедитесь, что целевой экземпляр находится в статусе **Рабочий**.

    ##### Процедура

    1. Нажмите **MySQL-PXC** в левой навигационной панели.

    2. Нажмите на ***имя пространства имен***.

    3. Нажмите на ***имя экземпляра***.

    4. Нажмите **Восстановить** на вкладке **Резервное копирование и восстановление**.

    5. Выберите целевой экземпляр и нажмите **Восстановить**. Пожалуйста, наберитесь терпения, пока целевой экземпляр не покажет статус **Восстановление успешно**.

    #### Удаление резервной копии

    Поддерживает удаление данных резервной копии.

    ##### Процедура

    1. Нажмите **MySQL-PXC** в левой навигационной панели.

    2. Нажмите на ***имя пространства имен***.

    3. Нажмите на ***имя экземпляра***.

    4. Нажмите **Удалить** на вкладке **Резервное копирование и восстановление** и подтвердите.

       При удалении данных резервной копии S3 также будут удалены данные в S3 хранилище.
  </Tab>
</Tabs>
